{% extends "base.html" %}
{% block content %}

<style>
  body {
    background: linear-gradient(135deg, #2c5364, #ffffff, #2c5364);
    color: #f5f5f5;
    font-family: "Poppins", sans-serif;
  }

  .profile-wrapper {
    max-width: 1100px;
    margin: 40px auto;
  }

  .profile-card {
    background: linear-gradient(135deg, #2c5364, #2c5364);
    border-radius: 20px;
    padding: 30px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.4);
    display: flex;
    justify-content: space-between;
    gap: 30px;
  }

  .profile-info h2 {
    font-weight: 600;
    margin-bottom: 20px;
  }

  .profile-info p {
    margin: 6px 0;
    font-size: 16px;
  }

  .label {
    color: #bcdcff;
    font-weight: 500;
  }

  .settings-box {
    text-align: right;
  }

  .settings-btn {
    background: #ff9f43;
    border: none;
    padding: 10px 20px;
    border-radius: 10px;
    font-weight: 600;
    color: #000;
    transition: 0.3s;
  }

  .settings-btn:hover {
    background: #ff6f00;
  }

  .orders-section {
    margin-top: 50px;
    background: #2c5364;
    border-radius: 20px;
    padding: 30px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.4);
  }

  .order-card {
    background: #1f2937;
    border-radius: 15px;
    padding: 20px;
    margin-bottom: 20px;
  }

  .item-img {
    width: 60px;
    height: 60px;
  }
</style>

<div class="profile-wrapper">

  <!-- PROFILE HEADER -->
  <div class="profile-card">
    <div class="profile-info">
      <h2>ğŸ‘¤ Profile</h2>
      <p><span class="label">Username:</span> {{ user.username }}</p>
      <p><span class="label">Name:</span> {{ user.name or "â€”" }}</p>
      <p><span class="label">Phone:</span> {{ user.phone_number or "â€”" }}</p>
      <p><span class="label">Email:</span> {{ user.email }}</p>
      <p><span class="label">Address:</span> {{ user.address or "â€”" }}</p>
    </div>

    <div class="settings-box">
      <a href="{{ url_for('change_password') }}">
        <button class="settings-btn">âš™ Change Password</button>
      </a>
      <a href="{{ url_for('edit_profile') }}">
        <button class="settings-btn">ğŸ–Šï¸ Edit Profile</button>
      </a>
    </div>
  </div>

  <!-- ORDERS -->
  <div class="orders-section">
    <h3 class="mb-4">ğŸ§¾ Your Order History</h3>

    {% if orders %}
      {% for order in orders %}
        <div class="order-card">

          <div class="d-flex justify-content-between">
            <div>
              <h5 class="fw-bold">Order #{{ order.order_id }}</h5>
              <p>ğŸ“… Order Date: {{ order.created_at }}</p>
              <p>ğŸšš Preferred Date: {{ order.delivery_date }}</p>
              <p>ğŸ˜ï¸ Address: {{ order.address }}</p>
            </div>

            <div>
              {% if order.status == "Completed" %}
                <span class="badge bg-success px-3 py-2">Completed</span>
              {% elif order.status == "Cancelled" %}
                <span class="badge bg-danger px-3 py-2">Cancelled</span>
              {% elif order.status == "Return Requested" %}
                <span class="badge bg-warning text-dark px-3 py-2">Return Requested</span>
              {% elif order.status == "Returned" %}
                <span class="badge bg-danger px-3 py-2">Returned</span>
              {% else %}
                <span class="badge bg-warning text-dark px-3 py-2">Pending</span>
              {% endif %}
            </div>
          </div>

          {% if order.discount > 0 %}
            <p class="mt-2">ğŸ’° Total: â‚¹{{ order.total_amount }}</p>
            <p>ğŸ’¸ Discount: -â‚¹{{ order.discount }}</p>
            <p><strong>ğŸ’µ To Pay: â‚¹{{ order.total_after_discount }}</strong></p>
          {% else %}
            <p class="mt-2">ğŸ’° Total: â‚¹{{ order.total_amount }}</p>
          {% endif %}

          {% if order.status == "Completed" %}
            <p>âœ” Delivered On: {{ order.delivered_at }}</p>
          {% elif order.status == "Returned" %}
            <p>â†© Returned On: {{ order.returned_at }}</p>
          {% elif order.status == "Cancelled" %}
            <p>âŒ Cancelled On: {{ order.cancelled_at }}</p>
          {% endif %}

          <hr>
          <h6 class="fw-bold mb-3">ğŸ–¼ Items</h6>

          {% for item in order["items"] %}
            <div class="d-flex align-items-center mb-2">
              <img src="{{ item.image_url }}"
                   onerror="this.src='{{ url_for('static', filename='images/placeholder.png') }}'"
                   class="item-img me-3">

              <div>
                <strong>{{ item.title }}</strong><br>
                <span class="text-muted">â‚¹{{ item.unit_price }} Ã— {{ item.quantity }}</span>
              </div>
            </div>

            <!-- â­ REVIEW -->
            {% if order.status in ['Completed', 'Returned'] %}
              {% if not item.reviewed %}
                <form method="POST"
                      action="{{ url_for('add_review',
                                         artwork_id=item.artwork_id,
                                         order_id=order.order_id) }}"
                      class="ms-5 mt-2">

                  <select name="rating"
                          class="form-select form-select-sm w-50 mb-2"
                          required>
                    <option value="">Rate â­</option>
                    {% for i in range(1,6) %}
                      <option value="{{ i }}">{{ i }} â­</option>
                    {% endfor %}
                  </select>

                  <textarea name="comment"
                            class="form-control form-control-sm w-75"
                            placeholder="Write your review..."
                            required></textarea>

                  <button class="btn btn-sm btn-success mt-2">Submit Review</button>
                </form>
              {% else %}
                <p class="text-success fst-italic ms-5">
                  âœ” You already reviewed this artwork
                </p>
              {% endif %}
            {% endif %}
          {% endfor %}

          <a href="{{ url_for('download_invoice', order_id=order.order_id) }}"
             class="btn btn-sm btn-outline-light mt-3">
            ğŸ“„ Download Invoice
          </a>

          {% if order.status not in ['Completed','Cancelled','Return Requested','Returned'] %}
            <a href="{{ url_for('cancel_order', order_id=order.order_id) }}"
               class="btn btn-sm btn-danger mt-2">
              Cancel Order
            </a>
          {% elif order.status == 'Return Requested' %}
            <a href="{{ url_for('cancel_request', order_id=order.order_id) }}"
               class="btn btn-sm btn-warning mt-2">
              Cancel Return Request
            </a>
          {% endif %}

          {% if order.return_allowed %}
            <a href="{{ url_for('return_order', order_id=order.order_id) }}"
               class="btn btn-sm btn-warning mt-2">
              Return
            </a>
          {% endif %}
        </div>
      {% endfor %}
    {% else %}
      <p class="text-muted">You have no orders yet.</p>
    {% endif %}
  </div>
</div>

{% endblock %}
